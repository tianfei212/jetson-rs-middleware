# Jetson 平台 RealSense D455 RGB 流修复完整指南

> **适用场景**：Intel RealSense D455 深度相机在 NVIDIA Jetson 平台上深度流正常，但 RGB 彩色流显示 "No Frames Received"

---

## 目录
1. [问题现象](#问题现象)
2. [根本原因](#根本原因)
3. [硬件连接](#硬件连接)
4. [系统环境检查](#系统环境检查)
5. [解决方案：RSUSB 后端编译](#解决方案rsusb-后端编译)
6. [完整安装步骤](#完整安装步骤)
7. [验证成功](#验证成功)
8. [故障排除](#故障排除)

---

## 问题现象

| 症状 | 状态 |
|------|------|
| 设备被系统识别 | ✅ 正常 |
| 深度流 (Depth) | ✅ 正常 |
| RGB 彩色流 | ❌ "No Frames Received" |
| 红外流 (IR) | 通常正常 |

### 典型错误日志
```bash
# rs-enumerate-devices 显示 RGB 支持，但无法获取帧
# realsense-viewer 中 RGB 相机显示 "No Frames Received"
```

---

## 根本原因

**Jetson L4T 内核缺少 RealSense UVC Metadata 支持**

| 组件 | 问题 | 影响 |
|------|------|------|
| 内核 UVC 驱动 | 缺少 `V4L2_BUF_FLAG_META` 支持 | RGB 格式协商失败 |
| 内核补丁方案 | 需要重新编译内核（2.5GB+ 空间） | 根分区不足时不可行 |
| **RSUSB 后端** | **用户空间 USB 驱动，绕过内核** | **✅ 推荐方案** |

---

## 硬件连接

### 推荐连接方式

```
┌─────────────────┐      USB3.0 Cable      ┌─────────────┐
│                 │ ◄────────────────────► │             │
│  NVIDIA Jetson  │   (尽量短，< 2米)       │ RealSense   │
│  (主板USB3端口)  │                        │   D455      │
│                 │                        │             │
└─────────────────┘                        └─────────────┘
        ▲
        │ 避免使用：
        │ • USB Hub（特别是 Realtek Hub）
        │ • USB3.0 端口
        │ • 长电缆 (>3米)
        │
        └─ 如果必须用 Hub，选择带独立供电的 USB3 Hub
```

### 验证硬件连接

```bash
# 1. 检查 USB 设备识别
lsusb | grep Intel

# 预期输出：
Bus 002 Device 004: ID 8086:0b5c Intel Corp. Intel(R) RealSense(TM) Depth Camera 455

# 2. 检查 UVC 驱动加载
dmesg | grep -i "uvc\|realsense" | tail -20

# 3. 检查设备节点
ls -la /dev/video*

# 预期看到多个 video 设备（depth, rgb, ir）
```

---

## 系统环境检查

### 1. 检查磁盘空间

```bash
df -h

# 确保根分区有至少 2GB 可用空间
# 如果空间不足，清理后再继续：
sudo apt clean
sudo apt autoremove
```

### 2. 安装依赖

```bash
sudo apt update
sudo apt install -y \
    git \
    cmake \
    build-essential \
    libssl-dev \
    libusb-1.0-0-dev \
    libudev-dev \
    pkg-config \
    libgtk-3-dev \
    libglfw3-dev \
    libgl1-mesa-dev \
    libglu1-mesa-dev \
    python3-dev \
    python3-pip
```

### 3. 检查当前 librealsense 版本（如有）

```bash
# 如果之前安装过，建议先卸载
sudo apt remove librealsense2*
sudo rm -rf /usr/local/lib/librealsense*
sudo rm -rf /usr/local/include/librealsense*
```

---

## 解决方案：RSUSB 后端编译

### 什么是 RSUSB 后端？

| 特性 | 内核 UVC 后端 | RSUSB 后端 |
|------|-------------|-----------|
| 依赖 | 内核 UVC 驱动完整支持 | 用户空间 USB 库 |
| 内核要求 | 需要补丁 | 无需修改 |
| 兼容性 | 依赖内核版本 | 通用 |
| 性能 | 理论最优 | 略低（实际可忽略）|
| **Jetson 适用性** | ❌ 需要重编内核 | ✅ **推荐** |

---

## 完整安装步骤

### 步骤 1：下载源码

```bash
# 创建工作目录
mkdir -p ~/codes
cd ~/codes

# 克隆 librealsense（如果网络不好，可用 gitee 镜像）
git clone https://github.com/IntelRealSense/librealsense.git
# 或国内镜像：git clone https://gitee.com/mirrors/librealsense.git

cd librealsense
git checkout v2.54.1  # 选择稳定版本，或直接用 master
```

### 步骤 2：准备构建目录

```bash
# 创建并进入构建目录
mkdir build && cd build

# 清理（如果重新编译）
rm -rf *
```

### 步骤 3：CMake 配置（关键步骤）

```bash
cmake .. \
    -DFORCE_RSUSB_BACKEND=TRUE \
    -DCMAKE_BUILD_TYPE=Release \
    -DBUILD_EXAMPLES=TRUE \
    -DBUILD_GRAPHICAL_EXAMPLES=TRUE \
    -DCHECK_FOR_UPDATES=TRUE \
    -DBUILD_PYTHON_BINDINGS=TRUE \
    -DPYTHON_EXECUTABLE=/usr/bin/python3 \
    -DCMAKE_INSTALL_PREFIX=/usr/local
```

#### CMake 参数详解

| 参数 | 说明 | 必要性 |
|------|------|--------|
| `FORCE_RSUSB_BACKEND=TRUE` | **强制使用 RSUSB 后端，绕过内核 UVC** | ⭐ 必须 |
| `CMAKE_BUILD_TYPE=Release` | 发布模式编译，优化性能 | 推荐 |
| `BUILD_EXAMPLES=TRUE` | 编译示例程序 | 推荐 |
| `BUILD_GRAPHICAL_EXAMPLES=TRUE` | 编译 realsense-viewer GUI 工具 | 推荐 |
| `CHECK_FOR_UPDATES=TRUE` | 启用在线更新检查（需要网络） | 可选 |
| `BUILD_PYTHON_BINDINGS=TRUE` | 编译 Python 接口 | 按需 |
| `CMAKE_INSTALL_PREFIX` | 安装路径 | 默认即可 |

### 步骤 4：编译

```bash
# 编译（Jetson 建议 -j2 避免内存不足，桌面可用 -j$(nproc)）
make -j2 2>&1 | tee build.log

# 如果内存充足，可加速编译
make -j$(nproc)
```

**编译时间参考：**
- Jetson Nano: 30-60 分钟
- Jetson Orin: 10-20 分钟
- 桌面 x86: 5-10 分钟

### 步骤 5：安装

```bash
# 安装到系统
sudo make install

# 更新动态链接库缓存
sudo ldconfig

# 安装 udev 规则（设备权限）
sudo cp ../config/99-realsense-libusb.rules /etc/udev/rules.d/
sudo udevadm control --reload-rules && sudo udevadm trigger
```

### 步骤 6：配置环境（Python 用户）

```bash
# 添加到 PYTHONPATH（可选，建议添加到 ~/.bashrc）
export PYTHONPATH=$PYTHONPATH:/usr/local/lib/python3.8/pyrealsense2

# 或者创建 pyrealsense2 软链接到系统路径
sudo ln -s /usr/local/lib/python3.8/pyrealsense2 /usr/lib/python3/dist-packages/pyrealsense2
```

---

## 验证成功

### 验证 1：库文件安装

```bash
# 检查库文件
ls -la /usr/local/lib/librealsense2*

# 预期输出：
# librealsense2.so -> librealsense2.so.2.54
# librealsense2.so.2.54
# librealsense2-gl.so (如果编译了图形示例)
```

### 验证 2：设备枚举

```bash
rs-enumerate-devices

# 预期输出：
# Device info:
#   Name                   : Intel RealSense D455
#   Serial Number          : 038122250239
#   Firmware Version       : 5.15.0.2
#   ...
# 
# Stream Profiles supported by Stereo Module
#   Depth    : 848x480  @ 30fps  Z16
#   Infrared : 848x480  @ 30fps  Y8
#
# Stream Profiles supported by RGB Camera
#   Color    : 1280x720 @ 30fps  RGB8   ✅ 关键：RGB 配置显示正常
```

### 验证 3：RGB 流测试（关键）

```bash
# 启动查看器
realsense-viewer
```

**成功标志：**
1. 左侧设备列表显示 "Stereo Module" 和 "RGB Camera"
2. 点击 "RGB Camera" 的开关
3. **右侧显示彩色图像，无 "No Frames Received" 错误**
4. 帧率显示稳定（如 30 fps）

![成功状态](expected_success.png)
> 预期：RGB 窗口显示实时彩色画面，状态栏显示 1280x720 @ 30fps

### 验证 4：命令行测试

```bash
# 保存 RGB 帧到文件
rs-save-to-disk

# 或使用示例程序
rs-capture

# 或使用 Python
python3 -c "
import pyrealsense2 as rs
ctx = rs.context()
dev = ctx.query_devices()[0]
print(f'Device: {dev.get_info(rs.camera_info.name)}')
pipe = rs.pipeline()
cfg = rs.config()
cfg.enable_stream(rs.stream.color, 1280, 720, rs.format.rgb8, 30)
pipe.start(cfg)
frames = pipe.wait_for_frames()
color = frames.get_color_frame()
print(f'Color frame: {color.get_width()}x{color.get_height()}')
pipe.stop()
print('✅ RGB stream working!')
"
```

---

## 系统修改总结

| 修改项 | 位置 | 说明 |
|--------|------|------|
| 库文件 | `/usr/local/lib/librealsense2*` | 核心库和 GUI 库 |
| 头文件 | `/usr/local/include/librealsense2` | 开发头文件 |
| 可执行文件 | `/usr/local/bin/rs-*` | 工具程序（viewer, capture 等） |
| udev 规则 | `/etc/udev/rules.d/99-realsense-libusb.rules` | USB 设备权限 |
| Python 包 | `/usr/local/lib/python*/pyrealsense2` | Python 绑定 |
| 动态链接库缓存 | `/etc/ld.so.cache` | 更新以识别新库 |

---

## 故障排除

### 问题 1：编译时 libcurl 下载失败

```bash
# 症状：fatal: 无法访问 'https://github.com/curl/curl.git/'
# 解决：禁用更新检查
cmake .. -DFORCE_RSUSB_BACKEND=TRUE -DCHECK_FOR_UPDATES=FALSE
```

### 问题 2：realsense-viewer 找不到设备

```bash
# 检查权限
sudo usermod -aG video $USER
# 重新登录或：
newgrp video

# 检查 udev 规则
sudo udevadm control --reload-rules
sudo udevadm trigger
```

### 问题 3：RGB 仍显示 "No Frames Received"

```bash
# 1. 确认使用的是 RSUSB 后端
rs-enumerate-devices -d  # 查看驱动信息

# 2. 尝试降低分辨率/帧率
# 在 realsense-viewer 中测试 640x480 @ 15fps

# 3. 检查 USB 带宽
# 避免与其他高带宽设备共享 USB 控制器
```

### 问题 4：Python 导入失败

```bash
# 检查 Python 路径
python3 -c "import sys; print(sys.path)"

# 添加路径到 ~/.bashrc
echo 'export PYTHONPATH=/usr/local/lib/python3.8/pyrealsense2:$PYTHONPATH' >> ~/.bashrc
source ~/.bashrc
```

---

## 附录：内核补丁方案（备选）

如果 RSUSB 方案性能不满足要求，可考虑内核补丁：

```bash
# 需要 2.5GB+ 空间和较长时间
cd librealsense
./scripts/patch-realsense-ubuntu-L4T.sh

# 然后重新编译（不使用 FORCE_RSUSB_BACKEND）
cmake .. -DCMAKE_BUILD_TYPE=Release
```

> ⚠️ 仅推荐在根分区空间充足且熟悉内核编译时使用

---

## 参考链接

- [Intel RealSense 官方文档](https://dev.intelrealsense.com/docs)
- [librealsense GitHub](https://github.com/IntelRealSense/librealsense)
- [JetsonHacks RealSense 指南](https://github.com/JetsonHacksNano/installLibrealsense)

---

**文档版本**：v1.0  
**适用平台**：NVIDIA Jetson (L4T)  
**测试设备**：Intel RealSense D455  
**librealsense 版本**：v2.54.1+
```

---
